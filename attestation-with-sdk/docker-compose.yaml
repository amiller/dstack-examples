services:
  app:
    build:
      context: .
      dockerfile_inline: |
        FROM node:22-slim
        WORKDIR /app
        RUN npm init -y && npm install @phala/dstack-sdk
        RUN cat > index.mjs <<'SCRIPT'
        import { DstackClient } from "@phala/dstack-sdk"
        import { createServer } from "http"
        const client = new DstackClient()
        const [info, quote, key] = await Promise.all([
          client.info(),
          client.getQuote("example-report-data"),
          client.getKey("/example/key/path"),
        ])
        const results = {
          info,
          quote: { rtmrs: quote.rtmrs, reportData: quote.report_data },
          key: { path: "/example/key/path", hex: key.key?.slice(0, 64) + "..." },
        }
        console.log("Attestation results:", JSON.stringify(results, null, 2))
        createServer((req, res) => {
          res.writeHead(200, { "Content-Type": "application/json" })
          res.end(JSON.stringify(results, null, 2))
        }).listen(8080, () => console.log("Serving at http://localhost:8080"))
        SCRIPT
        CMD ["node", "index.mjs"]
    ports:
      - "8080:8080"
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock
